<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Proza Frontend</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        input { padding: 10px; margin: 5px; width: 200px; }
    </style>
</head>
<body>
    <h1>🧪 Debug Proza Frontend</h1>
    
    <div>
        <h3>Teste de Conexão</h3>
        <button onclick="testConnection()">Testar Conexão</button>
        <div id="connectionStatus" class="log">Status: Aguardando teste...</div>
    </div>

    <div>
        <h3>Registro de Usuário</h3>
        <input type="text" id="username" placeholder="Nome do usuário" value="TestUser">
        <button onclick="registerUser()">Registrar</button>
        <div id="registerStatus" class="log">Status: Aguardando registro...</div>
    </div>

    <div>
        <h3>Envio de Mensagem</h3>
        <input type="text" id="message" placeholder="Digite uma mensagem" value="Olá, teste!">
        <button onclick="sendMessage()">Enviar Mensagem</button>
        <div id="messageStatus" class="log">Status: Aguardando envio...</div>
    </div>

    <div>
        <h3>Logs do Sistema</h3>
        <button onclick="clearLogs()">Limpar Logs</button>
        <div id="logs" class="log" style="height: 300px; overflow-y: auto;"></div>
    </div>

    <script>
        let socket = null;
        let connected = false;
        let registered = false;
        let user = null;

        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const logClass = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            logsDiv.innerHTML += `<div class="${logClass}">[${timestamp}] ${message}</div>`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        function updateConnectionStatus(status, type = 'info') {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.textContent = `Status: ${status}`;
            statusDiv.className = `log ${type}`;
        }

        function updateRegisterStatus(status, type = 'info') {
            const statusDiv = document.getElementById('registerStatus');
            statusDiv.textContent = `Status: ${status}`;
            statusDiv.className = `log ${type}`;
        }

        function updateMessageStatus(status, type = 'info') {
            const statusDiv = document.getElementById('messageStatus');
            statusDiv.textContent = `Status: ${status}`;
            statusDiv.className = `log ${type}`;
        }

        function testConnection() {
            log('🔌 Iniciando teste de conexão...', 'info');
            updateConnectionStatus('Conectando...', 'warning');

            if (socket) {
                socket.disconnect();
            }

            socket = io('http://localhost:3001', {
                transports: ['websocket', 'polling'],
                forceNew: true
            });

            socket.on('connect', () => {
                connected = true;
                log('✅ Socket conectado! ID: ' + socket.id, 'success');
                updateConnectionStatus('Conectado - ID: ' + socket.id, 'success');
            });

            socket.on('connect_error', (error) => {
                connected = false;
                log('❌ Erro de conexão: ' + error.message, 'error');
                updateConnectionStatus('Erro: ' + error.message, 'error');
            });

            socket.on('disconnect', () => {
                connected = false;
                registered = false;
                user = null;
                log('🔌 Socket desconectado', 'warning');
                updateConnectionStatus('Desconectado', 'warning');
                updateRegisterStatus('Desconectado', 'warning');
            });

            socket.on('register-success', (data) => {
                registered = true;
                user = {
                    id: data.clientId,
                    name: data.message ? data.message.replace('Bem-vindo ', '') : 'unknown'
                };
                log('✅ Registro bem-sucedido: ' + JSON.stringify(data), 'success');
                updateRegisterStatus('Registrado - ' + user.name, 'success');
            });

            socket.on('register-error', (data) => {
                registered = false;
                log('❌ Erro no registro: ' + data.message, 'error');
                updateRegisterStatus('Erro: ' + data.message, 'error');
            });

            socket.on('new-message', (message) => {
                log('📨 Nova mensagem recebida: ' + JSON.stringify(message), 'success');
                updateMessageStatus('Mensagem recebida: ' + message.message, 'success');
            });

            socket.on('user-joined', (data) => {
                log('👤 Usuário entrou: ' + JSON.stringify(data), 'info');
            });

            socket.on('user-left', (data) => {
                log('👤 Usuário saiu: ' + JSON.stringify(data), 'info');
            });

            socket.on('error', (error) => {
                log('❌ Erro do servidor: ' + JSON.stringify(error), 'error');
            });
        }

        function registerUser() {
            if (!connected) {
                log('❌ Socket não está conectado. Execute o teste de conexão primeiro.', 'error');
                updateRegisterStatus('Socket não conectado', 'error');
                return;
            }

            const username = document.getElementById('username').value.trim();
            if (!username) {
                log('❌ Nome de usuário não pode estar vazio', 'error');
                updateRegisterStatus('Nome vazio', 'error');
                return;
            }

            log('👤 Tentando registrar usuário: ' + username, 'info');
            updateRegisterStatus('Registrando...', 'warning');
            socket.emit('register', { username });
        }

        function sendMessage() {
            if (!connected || !registered) {
                log('❌ Usuário não está conectado ou registrado', 'error');
                updateMessageStatus('Não conectado/registrado', 'error');
                return;
            }

            const message = document.getElementById('message').value.trim();
            if (!message) {
                log('❌ Mensagem não pode estar vazia', 'error');
                updateMessageStatus('Mensagem vazia', 'error');
                return;
            }

            log('📤 Enviando mensagem: ' + message, 'info');
            updateMessageStatus('Enviando...', 'warning');
            socket.emit('send-message', { message, type: 'text' });
        }

        // Auto conectar quando a página carrega
        window.onload = () => {
            log('🎯 Página carregada. Clique em "Testar Conexão" para começar.', 'info');
        };
    </script>
</body>
</html>
